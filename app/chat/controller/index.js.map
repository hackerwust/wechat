{
    "version": 3,
    "sources": [
        "../../../src/chat/controller/index.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "../../../src/chat/controller/index.js",
    "sourcesContent": [
        "'use strict';\n\nlet sockets = {};\nlet uid_arr = [];\n\nfunction deepClone(obj) {\n  if (!obj || typeof obj !== \"object\" || typeof obj == 'function') {\n    return obj;\n  }\n  var res = Array.isArray(obj) ? [] : obj.constructor ? new obj.constructor() : {};\n  for (var key in obj) {\n    res[key] = deepClone(obj[key]);\n  }\n  return res;\n}\n\nimport Base from './base.js';\n\nexport default class extends Base {\n  init(...args) {\n    super.init(...args);\n    this.user = this.model(\"user\");\n  }\n\n  async indexAction(self) {\n    var uid = self.cookie('uid');\n    uid = parseInt(uid, 10) || 0;\n    if (!uid) {\n      return self.redirect(\"/home/index\");\n    }\n    var uinfo = await self.user.where({_id: uid}).find();\n    if (think.isEmpty(uinfo)) {\n      return self.redirect(\"/home/index\");\n    }\n    var friends = await self.user.where({_id: {\"$ne\": uid}}).select();\n    friends.map(item => {\n      if (uid_arr.indexOf(item._id) == -1) {\n        item.online = \"off\";\n      } else {\n        item.online = \"on\";\n      }\n    });\n    var logs = await getlog(\"group\", \"\");\n    await self.addPhoto(logs);\n    self.assign({self: uinfo, friends, logs});\n    return this.display();\n  }\n\n  async addPhoto(logs) {\n    var self = this;\n    var photo_hash = new Map();\n    for (var i = 0, len = logs.length; i < len; i++) {\n      var uid = logs[i].uid;\n      if (!photo_hash.has(uid)) {\n        var info = await self.user.where({_id: uid}).find();\n        photo_hash.set(uid, info);\n      }\n      var user = photo_hash.get(uid);\n      logs[i].photo = user.photo;\n      logs[i].name = user.name;\n    }\n  }\n\n  async dologoutAction(self) {\n    this.cookie(\"uid\", null);\n    return this.redirect(\"/home/index/index\");\n  }\n\n  // 建立socket连接时铜鼓socket.handshake.headers.cookie获得cookie\n  async connectAction(self) {\n    var http = self.http;\n    var socket = http.socket;\n    var headers = socket.handshake.headers;\n    var reg = /uid=(\\d+)/;\n    var uid = parseInt(headers.cookie.match(reg)[1], 10) || 0;\n    if (!uid) {\n      await self.dologoutAction();\n    }\n    var uinfo = await self.user.where({_id: uid}).find();\n    uid_arr.push(uid);\n    sockets[\"u\" + uid] = socket;\n    // 有刚注册登录进来的用户\n    uinfo.online = \"on\";\n    self.broadcast(\"online\", {uinfo}); \n  }\n\n  async closeAction(self) {\n    var http = self.http;\n    var socket = http.socket;\n    var data = http.data;\n    var headers = socket.handshake.headers;\n    var reg = /uid=(\\d+)/;\n    var uid = parseInt(headers.cookie.match(reg)[1], 10) || 0;\n    var index = uid_arr.indexOf(uid);\n    if (index > -1) {\n      uid_arr.splice(index, 1);\n    }\n    if (sockets[\"u\" + uid]) {\n      delete sockets[\"u\" + uid];\n    }\n    var uinfo = await self.user.where({_id: uid}).find();\n    uinfo.online = \"off\";\n    self.broadcast(\"offline\", {uinfo});\n  }\n\n  async getmsgAction(self) {\n    var http = self.http;\n    var socket = http.socket;\n    var msg = http.data;\n    var log = deepClone(msg.data);\n    delete log.name;\n    delete log.photo;\n    savelog(msg.other, msg.data.uid, log);\n    msg.data.to = msg.other;\n    if (msg.other == \"group\") {\n      self.broadcast(\"newlog\", msg.data);\n    } else {\n      // 获得发送对象socket\n      var target_socket = sockets[\"u\" + msg.other];\n      if (target_socket) {\n        target_socket.emit(\"newlog\", msg.data);\n      }\n    }\n  }\n\n  async changephotoAction(self) {\n    var http = self.http;\n    var photo = http.file(\"photo\");\n    var uid = parseInt(http.post(\"uid\"), 10) || 0;\n    if (think.isEmpty(photo) || !uid) {\n      return http.json({status: \"failed\", reason: \"图片传输失败或者uid为空\"});\n    }\n    var path = await savePhoto(photo.path, uid);\n    if (path) {\n      var row = await self.user.where({_id: uid}).update({photo: path});\n      if (row >= 0) {\n        return http.json({status: \"success\", path: path});\n      }\n      return http.json({status: \"failed\", reason: \"数据库更新失败\"});\n    } else {\n      return http.json({status: \"failed\", reason: \"保存失败\"});\n    }\n  }\n\n  async saveAction(self) {\n    var http = self.http;\n    var name = http.post(\"name\");\n    var pass = http.post(\"pass\");\n    var uid = parseInt(http.post(\"uid\"), 10) || 0;\n    if (!uid) {\n      return http.json({status: \"failed\", reason: \"uid为空\"});\n    }\n    var row = await self.user.where({_id: uid}).update({name: name, pass: pass});\n    if (row >= 0) {\n      return http.json({status: \"success\"});\n    } else {\n      return http.json({status: \"failed\", reason: \"数据库更新失败\"});\n    }\n  }\n\n  async getlogAction(self) {\n    var http = self.http;\n    var uid = http.post(\"uid\");\n    var other_id = http.post(\"other\");\n    // other_id 在前， 可能是group\n    var logs = await getlog(other_id, uid);\n    await self.addPhoto(logs);\n    return http.json({status: \"success\", data: logs});\n  }\n  \n}"
    ]
}