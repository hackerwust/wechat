{
    "version": 3,
    "sources": [
        "../../../src/chat/controller/index.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "../../../src/chat/controller/index.js",
    "sourcesContent": [
        "'use strict';\n\nlet fs = require(\"fs\");\nlet sockets = {};\nlet uid_arr = [];\n\nimport Base from './base.js';\n\nexport default class extends Base {\n  init(...args) {\n    super.init(...args);\n    this.user = this.model(\"user\");\n  }\n\n  async indexAction(self) {\n    var uid = self.cookie('uid');\n    uid = parseInt(uid, 10) || 0;\n    if (!uid) {\n      return self.redirect(\"/home/index\");\n    }\n    var uinfo = await self.user.where({_id: uid}).find();\n    if (think.isEmpty(uinfo)) {\n      return self.redirect(\"/home/index\");\n    }\n    var friends = await self.user.where({_id: {\"$ne\": uid}}).select();\n    friends.map(item => {\n      if (uid_arr.indexOf(item._id) == -1) {\n        item.online = \"off\";\n      } else {\n        item.online = \"on\";\n      }\n    });\n    var logs = await getlog(\"group\", \"\");\n    self.assign({self: uinfo, friends, logs});\n    return this.display();\n  }\n  \n  async dologoutAction(self) {\n    this.cookie(\"uid\", null);\n    return this.redirect(\"/home/index/index\");\n  }\n\n  // 建立socket连接时铜鼓socket.handshake.headers.cookie获得cookie\n  async connectAction(self) {\n    var http = self.http;\n    var socket = http.socket;\n    var headers = socket.handshake.headers;\n    var reg = /uid=(\\d+)/;\n    var uid = parseInt(headers.cookie.match(reg)[1], 10) || 0;\n    if (!uid) {\n      await self.dologoutAction();\n    }\n    var uinfo = await self.user.where({_id: uid}).find();\n    uid_arr.push(uid);\n    sockets[\"u\" + uid] = socket;\n    // 有刚注册登录进来的用户\n    uinfo.online = \"on\";\n    self.broadcast(\"online\", {uinfo}); \n  }\n\n  async closeAction(self) {\n    var http = self.http;\n    var socket = http.socket;\n    var data = http.data;\n    var headers = socket.handshake.headers;\n    var reg = /uid=(\\d+)/;\n    var uid = parseInt(headers.cookie.match(reg)[1], 10) || 0;\n    var index = uid_arr.indexOf(uid);\n    if (index > -1) {\n      uid_arr.splice(index, 1);\n    }\n    if (sockets[\"u\" + uid]) {\n      delete sockets[\"u\" + uid];\n    }\n    var uinfo = await self.user.where({_id: uid}).find();\n    uinfo.online = \"off\";\n    self.broadcast(\"offline\", {uinfo});\n  }\n\n  async getmsgAction(self) {\n    var http = self.http;\n    var socket = http.socket;\n    var msg = http.data;\n    savelog(msg.other, msg.data.uid, msg.data);\n    msg.data.to = msg.other;\n    if (msg.other == \"group\") {\n      self.broadcast(\"newlog\", msg.data);\n    } else {\n      // 获得发送对象socket\n      var target_socket = sockets[\"u\" + msg.other];\n      if (target_socket) {\n        target_socket.emit(\"newlog\", msg.data);\n      }\n    }\n  }\n\n  async getlogAction(self) {\n    try {\n      var http = self.http;\n      var uid = http.post(\"uid\");\n      var other_id = http.post(\"other\");\n      // other_id 在前， 可能是group\n      var logs = await getlog(other_id, uid);\n      return http.json({status: \"success\", data: logs});\n    } catch (e) {\n      return http.json({status: \"failed\"});\n    }\n  }\n  \n}"
    ]
}